jQuery(document).ready(function(a){"use strict";a(window).load(function(){var b={attached_files:""},c=function(c,d,e){var f=c.target.files;if(!(f.length<=0)){var g=new FormData,h="#"+d+" ",i=c.target.files[0].name,j=0;if(f.length>=1&&a.each(f,function(){this.size>parseInt(task_breakerProjectSettings.max_file_size)&&j++}),j>=1)return void alert("There was an error uploading your file. File size exceeded the allowed number of bytes per request.");a(h+".tasbreaker-file-attached").html(i),a.each(f,function(a,b){g.append(a,b)}),"null"!=typeof e&&a.each(e,function(a,b){g.append(a,b)}),g.append("action","task_breaker_transactions_request"),g.append("method","task_breaker_transaction_task_file_attachment"),g.append("nonce",task_breakerProjectSettings.nonce),a(h+".taskbreaker-upload-error").remove(),a(h+".taskbreaker-upload-error-text-helper").removeClass("active"),a(h+".taskbreaker-upload-success-text-helper").removeClass("active"),a.ajax({url:task_breakerAjaxUrl,type:"POST",data:g,cache:!1,dataType:"json",processData:!1,contentType:!1,success:function(c,d,e){"undefined"==typeof c.error?0!==c?"fail"===c.message?(b.attached_files="",a(h+".tb-file-attachment-progress").parent().append('<div class="taskbreaker-upload-error">'+c.response+"</div>"),a(h+".taskbreaker-upload-error-text-helper").addClass("active"),a(h+".taskbreaker-upload-success-text-helper").removeClass("active")):(b.attached_files=c.file,a(h+".taskbreaker-upload-error").remove(),a(h+".taskbreaker-upload-error-text-helper").removeClass("active"),a(h+".taskbreaker-upload-success-text-helper").addClass("active")):(a(h+".taskbreaker-upload-error-text-helper").addClass("active"),a(h+".taskbreaker-upload-success-text-helper").removeClass("active"),a(h+".tb-file-attachment-progress").parent().append('<div class="taskbreaker-upload-error">The application did not received any response from the server. Try uploading smaller files.</div>'),b.attached_files=""):console.log("File attachment errors debug: "+c.error)},error:function(a,b,c){console.log("File attachment errors debug: "+b)},xhr:function(){var b=a.ajaxSettings.xhr(),c=0,d="0%";return b.upload&&(a(h+".tb-file-attachment-progress-wrap").addClass("active"),a("#task_breaker-submit-btn").attr("disabled",!0),a("#task_breaker-edit-btn").attr("disabled",!0),b.upload.addEventListener("progress",function(b){b.lengthComputable&&(a("progress").attr({value:b.loaded,max:b.total}),c=b.loaded/b.total*100,"number"==typeof c&&(d=Math.floor(c)+"%",a(h+".tb-file-attachment-progress-movable").css({width:d}),a(h+".taskbreaker-upload-progress-value").html(d)))},!1)),b},complete:function(){console.log("finished"),a("#task_breaker-submit-btn").removeAttr("disabled"),a("#task_breaker-edit-btn").removeAttr("disabled")}})}},d=Backbone.View.extend({id:0,project_id:task_breakerProjectSettings.project_id,page:1,priority:-1,current_page:1,max_page:1,min_page:1,total:0,show_completed:"no",total_pages:0}),e=new d,f=Backbone.View.extend({el:"body",model:e,search:"",template:"",events:{"click .task_breaker-project-tab-li-item-a":"switchView","click .next-page":"next","click .prev-page":"prev","submit #task-breaker-search-task-form":"searchTasks","change #task_breaker-task-filter-select":"filter"},switchView:function(c,d){if(c){var e=a(c.currentTarget),f=["task_breaker-project-edit-tab","task_breaker-project-edit","task_breaker-project-add-new"],g=a.inArray(e.attr("id"),f);if(-1!==g)return!1}b.attached_files="",a(".tasbreaker-file-attached").html("No Files Selected."),a(".tb-file-attachment-progress-wrap").removeClass("active"),a("#task_breaker-project-edit-tab").css("display","none"),a("#task_breaker-project-add-new").css("display","none"),a(".task_breaker-project-tab-li-item").removeClass("active"),a(".task_breaker-project-tab-content-item").removeClass("active");var h="";if(c){var i=a(c.currentTarget);h=i.attr("data-content"),i.parent().addClass("active"),a("div[data-content="+h+"]").addClass("active")}else a(d).addClass("active"),h=a(d).attr("data-content"),a("a[data-content="+h+"]").parent().addClass("active")},hideFilters:function(){a("#task_breaker-tasks-filter").hide()},showFilters:function(){a("#task_breaker-tasks-filter").show()},searchTasks:function(b){var c=a("#task_breaker-task-search-field").val();return 0===c.length?location.href="#tasks":location.href="#tasks/search/"+encodeURI(c),!1},filter:function(a){this.model.priority=a.currentTarget.value;var b=Backbone.history.getFragment();"tasks"!=b?location.href="#tasks":this.render()},next:function(a){a.preventDefault();var b=this.model.page;b<this.model.max_page&&(this.model.page=++b,location.href="#tasks/page/"+this.model.page)},prev:function(a){a.preventDefault();var b=this.model.page;b>this.model.min_page&&(this.model.page=--b,location.href="#tasks/page/"+this.model.page)},single:function(b){this.progress(!0);var c=this;this.template="single_task_index",this.renderTask(function(b){c.progress(!1),"fail"==b.message&&a("#task_breaker-project-tasks").html("<p class='info' id='message'>"+b.message_long+"</p>"),b.html&&a("#task_breaker-project-tasks").html(b.html)})},showEditForm:function(c){var d=this,e="";"undefined"!=typeof tinymce&&(e=tinymce.get("task_breakerTaskEditDescription")),this.progress(!0),e?e.setContent(""):a("#task_breakerTaskEditDescription").val(""),a(".task_breaker-project-tab-content-item").removeClass("active"),a(".task_breaker-project-tab-li-item").removeClass("active"),a("a#task_breaker-project-edit-tab").css("display","block").parent().addClass("active"),a("#task_breaker-project-edit-context").addClass("active"),a("#task_breakerTaskId").attr("disabled",!0).val("loading..."),a("#task_breakerTaskEditTitle").attr("disabled",!0).val("loading..."),a("#task_breaker-task-edit-select-id").attr("disabled",!0),this.model.id=c,this.renderTask(function(c){if(d.progress(!1),c.task){var e=c.task,f="";"undefined"!=typeof tinymce&&(f=tinymce.get("task_breakerTaskEditDescription")),a("#task_breakerTaskId").val(e.id).removeAttr("disabled"),a("#task_breakerTaskEditTitle").val(e.title).removeAttr("disabled"),f?f.setContent(e.description):a("#task_breakerTaskEditDescription").val(e.description),a("#task-user-assigned-edit").val(""),document.getElementById("task-user-assigned-edit")&&(document.getElementById("task-user-assigned-edit").options.length=0),a.each(e.assign_users_meta.members_stack,function(a,b){var c=document.createElement("option");c.value=b.ID,c.text=b.display_name,c.selected="selected",document.getElementById("task-user-assigned-edit").appendChild(c)}),d.autoSuggestMembers(a("#task-user-assigned-edit"),!0,e),a("#task_breaker-task-edit-select-id").val(e.priority).change().removeAttr("disabled"),a("#task-breaker-form-file-attachment-edit-field").removeAttr("disabled"),e.meta?a.each(e.meta,function(c,d){if("file_attachment"===d.meta_key){var e="";a("#taskbreaker-file-attachment-edit .tasbreaker-file-attached").html(d.meta_value),b.attached_files=d.meta_value,e+='<a href="#" title="Click to remove file attachment" data-attachment="'+d.meta_value+'">&times;</a>',a("#taskbreaker-unlink-file-btn").html(e)}}):(a("#taskbreaker-file-attachment-edit .tasbreaker-file-attached").html("No files attached"),a("#taskbreaker-unlink-file-btn a").remove())}})},renderTask:function(b){a.ajax({url:ajaxurl,method:"get",dataType:"json",data:{action:"task_breaker_transactions_request",method:"task_breaker_transaction_fetch_task",id:this.model.id,project_id:this.model.project_id,template:this.template,nonce:task_breakerProjectSettings.nonce},success:function(a){b(a)}})},render:function(){var b=this;this.progress(!0),a.ajax({url:ajaxurl,method:"get",dataType:"json",data:{action:"task_breaker_transactions_request",method:"task_breaker_transaction_fetch_task",id:this.model.id,project_id:this.model.project_id,page:this.model.page,search:this.search,priority:this.model.priority,template:"render_tasks",show_completed:this.model.show_completed,nonce:task_breakerProjectSettings.nonce},success:function(c){b.progress(!1),"success"==c.message&&(c.task.stats&&(e.max_page=c.task.stats.max_page,e.min_page=c.task.stats.min_page),a("#task_breaker-project-tasks").html(c.html)),0===c.task.length&&a("#task_breaker-project-tasks").html('<div class="task-breaker-message danger">No tasks found. Try different keywords and filters.</div>')},error:function(){}})},initialize:function(){},progress:function(b){var c="none",d=1;b&&(c="block",d=.25),a("#task_breaker-preloader").css({display:c}),a("#task_breaker-project-tasks").css({opacity:d})},updateStats:function(b){var c=null,d=null;b.status&&(c=b.status.priority,d=b.status.task_status),d&&a("#task-details-status").text(d).removeClass("open close").addClass(d.toLowerCase()),c&&a("#task-details-priority").text(c).removeClass("normal high critical").addClass(c.toLowerCase()),a(".task_breaker-total-tasks").text(b.total),a(".task_breaker-remaining-tasks-count").text(b.remaining),a(".task-progress-completed").text(b.completed),a(".task-progress-percentage-label > span").text(b.progress),a(".task-progress-percentage").css({width:Math.ceil(b.completed/b.total*100)+"%"})},autoSuggestMembers:function(b,c,d){if(b){var e=function(b){if(b.avatar)var c=a('<span><img class="result-template-avatar" src="'+b.avatar+'" alt="s" />'+b.text+"</span>");return c};b.select2({maximumInputLength:20,placeholder:"Type member's name...",allowClear:!0,minimumResultsForSearch:1/0,minimumInputLength:2,tag:!0,ajax:{data:function(a){var c={action:"task_breaker_transactions_request",method:"task_breaker_transactions_user_suggest",nonce:task_breakerProjectSettings.nonce,group_id:task_breakerProjectSettings.current_group_id,term:a.term,user_id_collection:0};return b.val()&&(c.user_id_collection=b.val()),c},url:task_breakerAjaxUrl,delay:250,cache:!0},templateResult:e})}}}),g=new f,h=Backbone.Router.extend({routes:{tasks:"index","tasks/dashboard":"dashboard","tasks/settings":"settings","tasks/completed":"completed_tasks","tasks/add":"add","tasks/edit/:id":"edit","tasks/page/:page":"next","tasks/view/:id":"view_task","tasks/search/:search_keyword":"search"},view:g,model:e,index:function(){this.view.switchView(null,"#task_breaker-project-tasks-context"),this.model.page=1,this.model.id=0,this.model.show_completed="no",this.view.search="",this.view.render()},dashboard:function(){this.view.switchView(null,"#task_breaker-project-dashboard-context")},settings:function(){this.view.switchView(null,"#task_breaker-project-settings-context")},add:function(){this.view.switchView(null,"#task_breaker-project-add-new-context"),a("#task_breaker-project-add-new").css("display","block"),a("#task-user-assigned").val(""),this.view.autoSuggestMembers(a("#task-user-assigned"),!0,null),tinymce.editors.task_breakerTaskDescription&&tinymce.editors.task_breakerTaskDescription.setContent("")},completed_tasks:function(){this.view.switchView(null,"#task_breaker-project-tasks-context"),this.model.show_completed="yes",this.view.render()},edit:function(b){this.view.showEditForm(b),a("#task_breaker-edit-task-message").html("")},next:function(a){this.model.page=a,this.view.render()},view_task:function(a){this.model.id=a,this.view.single(a),this.view.switchView(null,"#task_breaker-project-tasks-context")},search:function(a){this.model.page=1,this.model.id=0,this.view.search=a,this.view.render()}}),i=new h;i.on("route",function(a){"view_task"===a?this.view.hideFilters():this.view.showFilters()}),Backbone.history.start(),a("#task_breaker-submit-btn").click(function(c){c.preventDefault();var d=a(this);d.attr("disabled",!0),d.text("Loading ...");var e="",f=tinymce.get("task_breakerTaskDescription");e=f?f.getContent():a("#task_breakerTaskDescription").val(),a.ajax({url:ajaxurl,data:{action:"task_breaker_transactions_request",method:"task_breaker_transaction_add_ticket",description:e,title:a("#task_breakerTaskTitle").val(),milestone_id:a("#task_breakerTaskMilestone").val(),priority:a("select#task_breaker-task-priority-select").val(),nonce:task_breakerProjectSettings.nonce,project_id:task_breakerTaskConfig.currentProjectId,user_id:task_breakerTaskConfig.currentUserId,user_id_collection:a("select#task-user-assigned").val(),file_attachments:b.attached_files},method:"post",success:function(b){parseInt(a(".task_breaker-total-tasks").text().trim()),parseInt(a(".task_breaker-remaining-tasks-count").text().trim());"success"===b.message?(d.text("Save Task"),d.removeAttr("disabled"),a("#task_breakerTaskDescription").val(""),a("#task_breakerTaskTitle").val(""),g.updateStats(b.stats),location.href="#tasks/view/"+b.response.id):(a("#task_breaker-add-task-message").html('<p class="error">'+b.response+"</p>").show().addClass("error"),d.text("Save Task"),d.removeAttr("disabled"))},error:function(){}})}),a("#task-breaker-form-file-attachment-field").on("change",function(a){c(a,"taskbreaker-file-attachment-add")}),b.attached_files="",a("#task_breaker-edit-btn").click(function(c){c.preventDefault();var d=a(this);d.attr("disabled",!0),d.text("Loading ...");var e="",f=tinymce.get("task_breakerTaskEditDescription");e=f?f.getContent():a("#task_breakerTaskEditDescription").val();var g={description:e,nonce:task_breakerProjectSettings.nonce,project_id:task_breakerTaskConfig.currentProjectId,user_id:task_breakerTaskConfig.currentUserId,action:"task_breaker_transactions_request",method:"task_breaker_transaction_edit_ticket",title:a("#task_breakerTaskEditTitle").val(),milestone_id:a("#task_breakerTaskMilestone").val(),id:a("#task_breakerTaskId").val(),priority:a('select[name="task_breaker-task-edit-priority"]').val(),user_id_collection:a("select#task-user-assigned-edit").val(),file_attachments:b.attached_files};a.ajax({url:ajaxurl,data:g,method:"post",success:function(b){var c="<p class='task-breaker-message success'>Task successfully updated <a href='#tasks/view/"+b.id+"'>&#65515; View</a></p>";"fail"===b.message&&"no_changes"!==b.type&&(c="<p class='task-breaker-message danger'>There was an error updating the task. All fields are required.</a></p>"),"fail"===b.message&&"unauthorized"===b.type&&(c="<p class='task-breaker-message danger'>You are not allowed to modify this task. Only group project administrators and group projects moderators are allowed.</a></p>"),a("#task_breaker-edit-task-message").html(c).show(),d.attr("disabled",!1),d.text("Update Task"),a("html, body").animate({scrollTop:a("#task_breaker-edit-task-message").offset().top-300},100)},error:function(){console.log("An Error Occured [task_breaker.js]#311")}})}),a("#task-breaker-form-file-attachment-edit-field").on("change",function(a){console.log("test");var b={edit_file_attachment:"yes"};c(a,"taskbreaker-file-attachment-edit",b)}),a("#task_breaker-project").on("click","#taskbreaker-unlink-file-btn > a",function(c){c.preventDefault();var d=confirm("Are you sure you want to delete this file attachment? This process is not reversible.");d&&console.log("deleting file...");var e=a("#task_breakerTaskId").val();a(".tasbreaker-file-attached").html("Deleting file attachment..."),a.ajax({method:"POST",url:task_breakerAjaxUrl,data:{nonce:task_breakerProjectSettings.nonce,ticket_id:e,action:"task_breaker_transactions_request",method:"task_breaker_transaction_delete_ticket_attachment"},success:function(c){a(".tasbreaker-file-attached").html("No files attached"),a("#taskbreaker-unlink-file-btn > a").remove(),b.attached_files=""}})}),a("body").on("click","#task_breaker-delete-btn",function(){var b=confirm("Are you sure you want to delete this task? This action is irreversible");if(b){var c=a(this),d=parseInt(e.id),f=parseInt(e.project_id),h={action:"task_breaker_transactions_request",method:"task_breaker_transaction_delete_ticket",id:d,project_id:f,nonce:task_breakerProjectSettings.nonce};g.progress(!0),c.text("Deleting ..."),a.ajax({url:ajaxurl,data:h,method:"post",success:function(b){if(g.progress(!1),g.updateStats(b.stats),"fail"===b.message){var d="<p class='task-breaker-message danger'>"+b.message_text+"</p>";return a("#task_breaker-edit-task-message").html(d).show(),!1}location.href="#tasks",g.switchView(null,"#task_breaker-project-tasks-context"),c.text("Delete")},error:function(){g.progress(!1),c.text("Delete")}})}}),a("body").on("click","#updateTaskBtn",function(){var b=a(this);b.attr("disabled","disabled");var c=e.id,d=a("#task-comment-content").val(),f=a("#task_breaker-task-priority-update-select").val(),h=a("input[name=task_commment_completed]:checked").val(),i=parseInt(e.project_id);if(0!==c){g.progress(!0);var j={action:"task_breaker_transactions_request",method:"task_breaker_transaction_add_comment_to_ticket",ticket_id:c,priority:f,details:d,completed:h,project_id:i,nonce:task_breakerProjectSettings.nonce};a.ajax({url:ajaxurl,data:j,method:"post",success:function(c){b.attr("disabled",!1),g.progress(!1),a("#task-comment-content").val(""),a("#task-lists").append(c.result),"yes"===h&&(a("#ticketStatusInProgress").attr("disabled",!0).attr("checked",!1),a("#ticketStatusComplete").attr("disabled",!0).attr("checked",!1),a("#comment-completed-radio").addClass("hide"),a("#ticketStatusCompleteUpdate").attr("disabled",!1).attr("checked",!0),a("#ticketStatusReOpenUpdate").attr("disabled",!1),a("#task_breaker-comment-completed-radio").removeClass("hide")),"reopen"===h&&(a("#ticketStatusInProgress").attr("disabled",!1).attr("checked",!0),a("#ticketStatusComplete").attr("disabled",!1).attr("checked",!1),a("#comment-completed-radio").removeClass("hide"),a("#ticketStatusCompleteUpdate").attr("disabled",!0).attr("checked",!1),a("#ticketStatusReOpenUpdate").attr("disabled",!0),a("#task_breaker-comment-completed-radio").addClass("hide")),g.updateStats(c.stats)},error:function(){b.attr("disabled",!1),g.progress(!1)}})}}),a("body").on("click","a.task_breaker-delete-comment",function(b){b.preventDefault();var c=confirm("Are you sure you want to delete this comment? This action is irreversible. ");if(!c)return!1;var d=a(this),e=parseInt(a(this).attr("data-comment-id")),f={action:"task_breaker_transactions_request",method:"task_breaker_transaction_delete_comment",comment_id:e,nonce:task_breakerProjectSettings.nonce};g.progress(!0),a.ajax({url:ajaxurl,data:f,method:"post",success:function(b){g.progress(!1),"success"==b.message?d.parent().parent().parent().parent().fadeOut(function(){a(this).remove()}):this.error()},error:function(){g.progress(!1),d.parent().append('<p class="error">Transaction Error: There was an error trying to delete this comment.</p>')}})}),a("body").on("click","#task_breakerUpdateProjectBtn",function(){var b=a(this),c="",d=tinymce.get("task_breakerProjectContent");c=d?d.getContent():a("#task_breakerProjectContent").val();var e={action:"task_breaker_transactions_request",method:"task_breaker_transactions_update_project",id:parseInt(a("#task_breaker-project-id").val()),title:a("#task_breaker-project-name").val(),content:c,group_id:parseInt(a("select[name=task_breaker-project-assigned-group]").val()),nonce:task_breakerProjectSettings.nonce};b.attr("disabled",!0).text("Updating ..."),g.progress(!0),a(".task_breaker-project-updated").remove(),a.ajax({url:ajaxurl,data:e,method:"post",success:function(c){g.progress(!1),b.attr("disabled",!1).text("Update Project"),"success"===c.message?(a("article .entry-header > .entry-title").text(a("#task_breaker-project-name").val()),b.parent().parent().prepend('<div id="message" class="task_breaker-project-updated success updated"><p>Project details successfully updated.</p></div>'),location.reload()):"authentication_error"===c.type?b.parent().parent().prepend('<div id="message" class="task_breaker-project-updated error updated"><p>Only group administrators and moderators can update the project settings.</p></div>'):b.parent().parent().prepend('<div id="message" class="task_breaker-project-updated success updated"><p>There was an error saving the project. All fields are required.</p></div>'),g.progress(!1),setTimeout(function(){a(".task_breaker-project-updated").fadeOut()},3e3)},error:function(){alert("connection failure")}})}),a("body").on("click","#task_breakerDeleteProjectBtn",function(){if(confirm("Are you sure you want to delete this project? All the tickets under this project will be deleted as well. This action cannot be undone.")){var b=a("#task_breaker-project-id").val(),c={action:"task_breaker_transactions_request",method:"task_breaker_transactions_delete_project",id:b,nonce:task_breakerProjectSettings.nonce};a(this).text("Deleting..."),a.ajax({url:ajaxurl,method:"post",data:c,success:function(a){"success"==a.message?window.location=a.redirect:this.error()},error:function(){alert("There was an error trying to delete this post. Try again later.")}})}})})});
//# sourceMappingURL=task-breaker.min.js.map